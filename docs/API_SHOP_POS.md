# API Документация для программы магазина (POS)

## Обзор

Эта документация описывает API эндпоинты для программы магазина (POS системы), которые позволяют:
- Регистрировать клиентов в системе бонусов
- Обновлять количество бонусов клиентов
- Управлять QR кодами клиентов

## Базовый URL

```
https://your-domain.com/api/v1
```

## Аутентификация

**Важно:** Эндпоинт регистрации клиентов является публичным, но требует проверки существования магазина по `shopId`.

## Эндпоинты

### 1. Регистрация/Обновление клиента магазина

Регистрирует нового клиента или обновляет количество бонусов существующего клиента.

**Endpoint:** `POST /shop/customers/register`

**Тип:** Публичный (без токена авторизации)

**Request Body:**

```json
{
  "shopId": "uuid-магазина",
  "phone": "+992901234567",
  "qrCode": "QR123456789",
  "bonusAmount": 150
}
```

**Параметры:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `shopId` | string (UUID) | Да | ID магазина в системе |
| `phone` | string | Да | Номер телефона клиента (в любом формате) |
| `qrCode` | string | Да (только при первой регистрации) | Уникальный QR код клиента в этом магазине |
| `bonusAmount` | integer | Да | Текущее количество бонусов клиента |

**Важные замечания:**

1. **При первой регистрации клиента:**
   - Обязательно передавайте `qrCode`
   - `bonusAmount` - начальное количество бонусов
   - Система создаст новую запись клиента

2. **При последующих обновлениях:**
   - `qrCode` можно не передавать (будет проигнорирован)
   - `bonusAmount` - новое текущее количество бонусов
   - Система автоматически определит изменение (начисление или списание) и создаст запись в истории

**Пример запроса (первая регистрация):**

```bash
curl -X POST https://your-domain.com/api/v1/shop/customers/register \
  -H "Content-Type: application/json" \
  -d '{
    "shopId": "123e4567-e89b-12d3-a456-426614174000",
    "phone": "+992 90 123 45 67",
    "qrCode": "SHOP1-CLIENT-001",
    "bonusAmount": 100
  }'
```

**Пример запроса (обновление бонусов):**

```bash
curl -X POST https://your-domain.com/api/v1/shop/customers/register \
  -H "Content-Type: application/json" \
  -d '{
    "shopId": "123e4567-e89b-12d3-a456-426614174000",
    "phone": "+992 90 123 45 67",
    "bonusAmount": 250
  }'
```

**Успешный ответ (200 OK):**

```json
{
  "success": true,
  "message": "Клиент успешно зарегистрирован",
  "data": {
    "id": "789e4567-e89b-12d3-a456-426614174001",
    "shopId": "123e4567-e89b-12d3-a456-426614174000",
    "phone": "+992901234567",
    "qrCode": "SHOP1-CLIENT-001",
    "bonusAmount": 100,
    "firstBonusDate": "2024-01-15T10:30:00Z",
    "shop": {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "name": "Мой Магазин",
      "inn": "123456789"
    },
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-01-15T10:30:00Z"
  }
}
```

**Ответ при обновлении:**

```json
{
  "success": true,
  "message": "Бонусы клиента успешно обновлены",
  "data": {
    "id": "789e4567-e89b-12d3-a456-426614174001",
    "shopId": "123e4567-e89b-12d3-a456-426614174000",
    "phone": "+992901234567",
    "qrCode": "SHOP1-CLIENT-001",
    "bonusAmount": 250,
    "firstBonusDate": "2024-01-15T10:30:00Z",
    "shop": {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "name": "Мой Магазин",
      "inn": "123456789"
    },
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-01-15T11:45:00Z"
  }
}
```

**Ошибки:**

**400 Bad Request** - Неверные данные запроса:
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Неверные данные запроса",
    "details": "qrCode: QR код обязателен при первой регистрации клиента"
  }
}
```

**404 Not Found** - Магазин не найден:
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "Магазин не найден"
  }
}
```

**409 Conflict** - QR код уже используется:
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "QR код уже используется другим клиентом в этом магазине"
  }
}
```

## Логика работы с бонусами

### Определение начисления/списания

Система автоматически определяет, было ли начисление или списание бонусов:

- **Начисление:** `новое количество > предыдущего` → положительное изменение
- **Списание:** `новое количество < предыдущего` → отрицательное изменение
- **Без изменений:** `новое количество = предыдущему` → запись в историю не создается

**Пример:**

1. Клиент имеет 100 бонусов
2. Магазин отправляет `bonusAmount: 150`
3. Система создает запись в истории: `changeAmount: +50` (начисление)

4. Позже магазин отправляет `bonusAmount: 120`
5. Система создает запись в истории: `changeAmount: -30` (списание)

### Нормализация номера телефона

Система автоматически нормализует номер телефона:
- Убирает пробелы, дефисы, скобки
- Оставляет только цифры и знак `+` в начале
- Пример: `"+992 90 123-45-67"` → `"+992901234567"`

## Рекомендации по использованию

1. **Хранение shopId:** Сохраните `shopId` вашего магазина в настройках программы POS
2. **QR коды:** Генерируйте уникальные QR коды для каждого клиента в вашем магазине
3. **Обновление бонусов:** Отправляйте только новое текущее количество бонусов, не вычисляйте разницу на стороне POS
4. **Обработка ошибок:** Всегда проверяйте ответ API и обрабатывайте ошибки
5. **Повторные попытки:** При сетевых ошибках реализуйте механизм повторных попыток

## Пример интеграции (псевдокод)

```javascript
// Функция регистрации/обновления клиента
async function registerOrUpdateCustomer(shopId, phone, qrCode, bonusAmount) {
  const payload = {
    shopId: shopId,
    phone: phone,
    bonusAmount: bonusAmount
  };
  
  // Добавляем QR код только при первой регистрации
  if (qrCode && !isClientExists(phone)) {
    payload.qrCode = qrCode;
  }
  
  try {
    const response = await fetch('https://your-domain.com/api/v1/shop/customers/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();
    
    if (data.success) {
      console.log('Клиент успешно зарегистрирован/обновлен');
      return data.data;
    } else {
      console.error('Ошибка:', data.error.message);
      throw new Error(data.error.message);
    }
  } catch (error) {
    console.error('Ошибка сети:', error);
    throw error;
  }
}

// Использование
// Первая регистрация
await registerOrUpdateCustomer(
  '123e4567-e89b-12d3-a456-426614174000',
  '+992 90 123 45 67',
  'SHOP1-CLIENT-001',
  100
);

// Обновление бонусов
await registerOrUpdateCustomer(
  '123e4567-e89b-12d3-a456-426614174000',
  '+992 90 123 45 67',
  null, // QR код не нужен
  250
);
```

## Вопросы и поддержка

При возникновении вопросов или проблем обращайтесь к администратору системы.

