# Changelog миграций базы данных

## 2024-12-01 - Добавление защиты от повторного использования лицензий

### Изменения в таблице `licenses`

Добавлены новые поля для защиты от использования одного ключа лицензии на нескольких устройствах:

1. **`device_id`** (VARCHAR(255), INDEX)
   - Уникальный ID устройства (например, Android ID или iOS IdentifierForVendor)
   - Используется для привязки лицензии к конкретному устройству

2. **`device_info`** (TEXT)
   - JSON строка с информацией о железе устройства
   - Содержит: платформу, модель, производителя, версию ОС, версию приложения и т.д.
   - Пример: `{"platform":"android","model":"Samsung Galaxy S21","manufacturer":"Samsung","osVersion":"Android 12","appVersion":"1.0.0"}`

3. **`device_fingerprint`** (VARCHAR(255), INDEX)
   - SHA256 хеш, созданный на основе `device_id` и `device_info`
   - Используется для быстрой проверки соответствия устройства
   - Формат: 64-символьная hex строка

### SQL миграция

Для ручного применения миграции используйте файл:
- `database/migrations/add_device_fields_to_licenses.sql`

Или миграция будет применена автоматически при следующем запуске приложения через GORM AutoMigrate.

### Обратная совместимость

- Все новые поля являются опциональными (NULL разрешен)
- Существующие лицензии продолжат работать
- Новые лицензии будут требовать `device_id` и `device_info` при активации

### Влияние на API

- Эндпоинт `POST /api/v1/licenses/check` теперь требует `deviceId` в запросе
- Эндпоинт `POST /api/v1/licenses/activate` теперь требует `deviceId` и `deviceInfo` в запросе
- При попытке активации лицензии на другом устройстве возвращается ошибка `403 Forbidden`

---

## 2024-12-01 - Добавление системы лицензий и подписок

### Новые таблицы

1. **`licenses`**
   - Хранит информацию о лицензиях магазинов
   - Связь с таблицами: `shops`, `users`
   - Поля: license_key, shop_id, user_id, subscription_type, subscription_status, expires_at и т.д.

2. **`subscription_plans`**
   - Хранит планы подписки (месячная, годовая, пожизненная)
   - Поля: name, description, subscription_type, price, currency, duration_months, features и т.д.

### Миграция

Таблицы создаются автоматически через GORM AutoMigrate при запуске приложения.

---

## Предыдущие миграции

(Добавьте сюда информацию о предыдущих миграциях, если нужно)

